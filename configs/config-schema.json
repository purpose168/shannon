{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/pentest-config-schema.json",
  "title": "渗透测试配置模式",
  "description": "渗透测试智能体中使用的 YAML 配置文件模式",
  "type": "object",
  "properties": {
    "authentication": {
      "type": "object",
      "description": "目标应用程序的认证配置",
      "properties": {
        "login_type": {
          "type": "string",
          "enum": ["form", "sso", "api", "basic"],
          "description": "认证机制类型"
        },
        "login_url": {
          "type": "string",
          "format": "uri",
          "description": "登录页面或端点的 URL"
        },
        "credentials": {
          "type": "object",
          "description": "登录凭证",
          "properties": {
            "username": {
              "type": "string",
              "minLength": 1,
              "maxLength": 255,
              "description": "用于认证的用户名或电子邮件"
            },
            "password": {
              "type": "string",
              "minLength": 1,
              "maxLength": 255,
              "description": "用于认证的密码"
            },
            "totp_secret": {
              "type": "string",
              "pattern": "^[A-Za-z2-7]+=*$",
              "description": "双因素认证的 TOTP 密钥（Base32 编码，不区分大小写）"
            }
          },
          "required": ["username", "password"],
          "additionalProperties": false
        },
        "login_flow": {
          "type": "array",
          "description": "登录过程的分步说明",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 500
          },
          "minItems": 1,
          "maxItems": 20
        },
        "success_condition": {
          "type": "object",
          "description": "指示认证成功的条件",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["url_contains", "element_present", "url_equals_exactly", "text_contains"],
              "description": "要检查的成功条件类型"
            },
            "value": {
              "type": "string",
              "minLength": 1,
              "maxLength": 500,
              "description": "要与成功条件匹配的值"
            }
          },
          "required": ["type", "value"],
          "additionalProperties": false
        }
      },
      "required": ["login_type", "login_url", "credentials", "success_condition"],
      "additionalProperties": false
    },
    "rules": {
      "type": "object",
      "description": "定义渗透测试期间应关注或避免的测试规则",
      "properties": {
        "avoid": {
          "type": "array",
          "description": "定义测试期间应避免的区域的规则",
          "items": {
            "$ref": "#/$defs/rule"
          },
          "maxItems": 50
        },
        "focus": {
          "type": "array",
          "description": "定义测试期间应关注的区域的规则",
          "items": {
            "$ref": "#/$defs/rule"
          },
          "maxItems": 50
        }
      },
      "additionalProperties": false
    },
    "login": {
      "type": "object",
      "description": "已弃用：请改用 'authentication' 部分",
      "deprecated": true
    }
  },
  "anyOf": [
    {"required": ["authentication"]},
    {"required": ["rules"]},
    {"required": ["authentication", "rules"]}
  ],
  "additionalProperties": false,
  "$defs": {
    "rule": {
      "type": "object",
      "description": "单个测试规则",
      "properties": {
        "description": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "规则的人类可读描述"
        },
        "type": {
          "type": "string",
          "enum": ["path", "subdomain", "domain", "method", "header", "parameter"],
          "description": "规则类型（要匹配请求的哪个方面）"
        },
        "url_path": {
          "type": "string",
          "minLength": 1,
          "maxLength": 1000,
          "description": "要匹配的 URL 路径模式或值"
        }
      },
      "required": ["description", "type", "url_path"],
      "additionalProperties": false
    }
  }
}