# Shannon 接口定义

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | 1.0.0 |
| 创建日期 | 2026-02-12 |
| 最后更新 | 2026-02-12 |
| 文档状态 | 正式发布 |
| 作者 | purpose168 |

---

## 目录

- [1. 接口概述](#1-接口概述)
- [2. CLI 接口](#2-cli-接口)
- [3. 工作流接口](#3-工作流接口)
- [4. 智能体接口](#4-智能体接口)
- [5. 审计接口](#5-审计接口)
- [6. 外部接口](#6-外部接口)
- [7. 错误码规范](#7-错误码规范)
- [8. 接口调用示例](#8-接口调用示例)

---

## 1. 接口概述

### 1.1 接口分类

Shannon 项目的接口分为以下几类：

| 接口类型 | 描述 | 主要使用者 |
|----------|------|------------|
| CLI 接口 | 命令行用户接口 | 最终用户 |
| 工作流接口 | Temporal 工作流接口 | 工作流编排 |
| 智能体接口 | AI 智能体接口 | 活动执行 |
| 审计接口 | 审计系统接口 | 日志记录 |
| 外部接口 | 外部服务接口 | 外部系统 |

### 1.2 接口设计原则

- **简洁性**：接口设计简洁明了，易于理解和使用
- **一致性**：接口命名和参数风格保持一致
- **可扩展性**：接口设计支持未来功能扩展
- **安全性**：接口设计考虑安全性，防止误用

---

## 2. CLI 接口

### 2.1 命令列表

| 命令 | 参数 | 描述 | 返回值 |
|------|------|------|--------|
| `start` | URL=目标URL REPO=代码仓库 [CONFIG=配置文件] | 启动渗透测试 | 工作流 ID |
| `logs` | - | 查看实时工作日志 | 日志输出 |
| `query` | ID=工作流ID | 查询工作流进度 | 工作流状态 |
| `stop` | [CLEAN=true] | 停止所有容器 | 操作结果 |

### 2.2 命令详细说明

#### 2.2.1 start 命令

**功能描述**：启动完整的渗透测试流程

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| URL | string | 是 | 目标应用程序的 URL |
| REPO | string | 是 | 目标代码仓库路径 |
| CONFIG | string | 否 | 自定义配置文件路径 |

**返回值**：

```json
{
  "workflowId": "shannon-1234567890",
  "status": "started",
  "message": "渗透测试已启动"
}
```

**使用示例**：

```bash
# 基本用法
./shannon start URL=https://example.com REPO=example-repo

# 使用配置文件
./shannon start URL=https://example.com REPO=example-repo CONFIG=./configs/my-config.yaml
```

#### 2.2.2 logs 命令

**功能描述**：查看实时工作日志

**参数说明**：无

**返回值**：实时日志输出

**使用示例**：

```bash
./shannon logs
```

#### 2.2.3 query 命令

**功能描述**：查询工作流进度

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| ID | string | 是 | 工作流 ID |

**返回值**：

```json
{
  "workflowId": "shannon-1234567890",
  "status": "running",
  "currentPhase": "vulnerability-analysis",
  "progress": 45,
  "estimatedTimeRemaining": "30 minutes"
}
```

**使用示例**：

```bash
./shannon query ID=shannon-1234567890
```

#### 2.2.4 stop 命令

**功能描述**：停止所有容器

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| CLEAN | boolean | 否 | 是否清理数据（默认 false） |

**返回值**：

```json
{
  "status": "stopped",
  "message": "所有容器已停止"
}
```

**使用示例**：

```bash
# 停止容器
./shannon stop

# 停止并清理数据
./shannon stop CLEAN=true
```

---

## 3. 工作流接口

### 3.1 工作流定义

#### 3.1.1 runPentestWorkflow

**功能描述**：运行完整的渗透测试工作流

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| url | string | 是 | 目标应用程序的 URL |
| repo | string | 是 | 目标代码仓库路径 |
| config | object | 否 | 配置对象 |

**返回值**：

```typescript
interface PentestWorkflowResult {
  workflowId: string;
  status: 'completed' | 'failed' | 'timeout';
  phases: {
    reconnaissance: PhaseResult;
    vulnerabilityAnalysis: PhaseResult;
    exploitation: PhaseResult;
    reporting: PhaseResult;
  };
  report: {
    path: string;
    summary: string;
  };
}
```

#### 3.1.2 runReconnaissance

**功能描述**：执行侦察阶段

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| url | string | 是 | 目标应用程序的 URL |
| repo | string | 是 | 目标代码仓库路径 |

**返回值**：

```typescript
interface ReconnaissanceResult {
  status: 'completed' | 'failed';
  attackSurface: {
    endpoints: Endpoint[];
    technologies: Technology[];
    subdomains: string[];
    ports: Port[];
  };
  duration: number;
}
```

#### 3.1.3 runVulnerabilityAnalysis

**功能描述**：执行漏洞分析阶段

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| reconData | object | 是 | 侦察阶段数据 |
| vulnerabilityType | string | 否 | 漏洞类型（可选） |

**返回值**：

```typescript
interface VulnerabilityAnalysisResult {
  status: 'completed' | 'failed';
  vulnerabilities: Vulnerability[];
  duration: number;
}
```

#### 3.1.4 runExploitation

**功能描述**：执行漏洞利用阶段

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| analysisData | object | 是 | 漏洞分析数据 |
| vulnerabilityType | string | 否 | 漏洞类型（可选） |

**返回值**：

```typescript
interface ExploitationResult {
  status: 'completed' | 'failed';
  exploits: Exploit[];
  proofsOfConcept: ProofOfConcept[];
  duration: number;
}
```

#### 3.1.5 generateReport

**功能描述**：生成渗透测试报告

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| allResults | object | 是 | 所有阶段的结果数据 |

**返回值**：

```typescript
interface ReportResult {
  status: 'completed' | 'failed';
  path: string;
  summary: string;
  vulnerabilities: VulnerabilitySummary[];
}
```

---

## 4. 智能体接口

### 4.1 智能体执行接口

#### 4.1.1 executeAgent

**功能描述**：执行智能体任务

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| prompt | string | 是 | 提示内容 |
| context | object | 是 | 上下文信息 |
| tools | string[] | 否 | 可用工具列表 |

**返回值**：

```typescript
interface AgentResponse {
  status: 'completed' | 'failed';
  message: string;
  toolCalls: ToolCall[];
  result: any;
  metrics: {
    turns: number;
    cost: number;
    duration: number;
  };
}
```

#### 4.1.2 handleMessage

**功能描述**：处理智能体消息

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| message | object | 是 | 消息对象 |
| context | object | 是 | 上下文信息 |

**返回值**：

```typescript
interface MessageHandlerResult {
  status: 'completed' | 'failed';
  response: string;
  actions: Action[];
}
```

#### 4.1.3 formatOutput

**功能描述**：格式化输出结果

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| output | any | 是 | 输出内容 |
| format | string | 是 | 格式类型 |

**返回值**：

```typescript
interface FormattedOutput {
  status: 'completed' | 'failed';
  content: string;
  format: string;
}
```

---

## 5. 审计接口

### 5.1 审计会话接口

#### 5.1.1 createAuditSession

**功能描述**：创建审计会话

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| sessionId | string | 是 | 会话 ID |
| targetUrl | string | 是 | 目标 URL |

**返回值**：

```typescript
interface AuditSession {
  sessionId: string;
  targetUrl: string;
  startTime: Date;
  status: 'active' | 'completed' | 'failed';
  logPath: string;
}
```

#### 5.1.2 logWorkflowEvent

**功能描述**：记录工作流事件

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| sessionId | string | 是 | 会话 ID |
| event | string | 是 | 事件类型 |
| data | object | 是 | 事件数据 |

**返回值**：

```typescript
interface LogResult {
  status: 'completed' | 'failed';
  timestamp: Date;
}
```

#### 5.1.3 trackMetrics

**功能描述**：跟踪执行指标

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| sessionId | string | 是 | 会话 ID |
| metrics | object | 是 | 指标数据 |

**返回值**：

```typescript
interface MetricsResult {
  status: 'completed' | 'failed';
  totalCost: number;
  totalTurns: number;
  totalTime: number;
}
```

#### 5.1.4 generateAuditReport

**功能描述**：生成审计报告

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| sessionId | string | 是 | 会话 ID |

**返回值**：

```typescript
interface AuditReport {
  status: 'completed' | 'failed';
  path: string;
  summary: string;
}
```

---

## 6. 外部接口

### 6.1 Claude API 接口

#### 6.1.1 messages.create

**功能描述**：创建消息并获取智能体响应

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| model | string | 是 | 模型名称 |
| messages | array | 是 | 消息列表 |
| tools | array | 否 | 工具列表 |
| tool_choice | object | 否 | 工具选择策略 |

**返回值**：

```typescript
interface ClaudeResponse {
  id: string;
  type: 'message';
  role: 'assistant';
  content: Content[];
  model: string;
  stop_reason: string;
  usage: {
    input_tokens: number;
    output_tokens: number;
  };
}
```

#### 6.1.2 messages.stream

**功能描述**：流式获取智能体响应

**参数说明**：

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| model | string | 是 | 模型名称 |
| messages | array | 是 | 消息列表 |
| tools | array | 否 | 工具列表 |
| tool_choice | object | 否 | 工具选择策略 |

**返回值**：流式响应

### 6.2 安全工具接口

#### 6.2.1 Nmap

| 工具 | 命令 | 参数 | 描述 | 返回值 |
|------|------|------|------|--------|
| Nmap | `nmap` | `-sV -p-` | 网络扫描 | 扫描结果 |

**使用示例**：

```bash
nmap -sV -p- target.com
```

#### 6.2.2 Subfinder

| 工具 | 命令 | 参数 | 描述 | 返回值 |
|------|------|------|------|--------|
| Subfinder | `subfinder` | `-d domain` | 子域名发现 | 子域名列表 |

**使用示例**：

```bash
subfinder -d target.com
```

#### 6.2.3 WhatWeb

| 工具 | 命令 | 参数 | 描述 | 返回值 |
|------|------|------|------|--------|
| WhatWeb | `whatweb` | `url` | 网站指纹识别 | 技术栈信息 |

**使用示例**：

```bash
whatweb https://target.com
```

#### 6.2.4 Schemathesis

| 工具 | 命令 | 参数 | 描述 | 返回值 |
|------|------|------|------|--------|
| Schemathesis | `schemathesis` | `run openapi.json` | API 测试 | 测试结果 |

**使用示例**：

```bash
schemathesis run openapi.json
```

---

## 7. 错误码规范

### 7.1 错误类型

| 错误类型 | 描述 | 可重试 | HTTP 状态码 |
|----------|------|--------|-------------|
| `config` | 配置文件问题 | 否 | 400 |
| `network` | 连接/超时问题 | 是 | 503 |
| `tool` | 外部工具失败 | 是 | 500 |
| `prompt` | Claude SDK/API 问题 | 有时 | 500 |
| `filesystem` | 文件读/写错误 | 有时 | 500 |
| `validation` | 交付物验证失败 | 是 | 400 |
| `billing` | API 配额/计费限制 | 否 | 429 |
| `unknown` | 意外错误 | 取决于 | 500 |

### 7.2 错误响应格式

```typescript
interface ErrorResponse {
  error: {
    type: string;
    message: string;
    code: string;
    retryable: boolean;
    context?: object;
  };
}
```

### 7.3 错误处理示例

```typescript
try {
  const result = await executeAgent(prompt, context, tools);
  return result;
} catch (error) {
  if (error instanceof PentestError) {
    if (error.retryable) {
      // 重试逻辑
      return await retryExecution(executeAgent, prompt, context, tools);
    } else {
      // 记录错误并返回
      logger.error(`不可重试的错误: ${error.message}`);
      throw error;
    }
  }
  throw error;
}
```

---

## 8. 接口调用示例

### 8.1 启动渗透测试

```bash
# 基本用法
./shannon start URL=https://example.com REPO=example-repo

# 使用配置文件
./shannon start URL=https://example.com REPO=example-repo CONFIG=./configs/my-config.yaml

# 自定义输出目录
./shannon start URL=https://example.com REPO=example-repo OUTPUT=./my-reports
```

### 8.2 查询工作流状态

```bash
# 查询特定工作流
./shannon query ID=shannon-1234567890

# 查看实时日志
./shannon logs
```

### 8.3 智能体执行

```typescript
// 执行侦察智能体
const reconResult = await executeAgent({
  prompt: "执行网站侦察，收集所有相关信息",
  context: {
    url: "https://example.com",
    repo: "example-repo"
  },
  tools: ["nmap", "subfinder", "whatweb"]
});

// 处理智能体响应
const processedResult = handleMessage({
  message: reconResult,
  context: { stage: "reconnaissance" }
});
```

### 8.4 审计日志记录

```typescript
// 创建审计会话
const session = await createAuditSession({
  sessionId: "shannon-1234567890",
  targetUrl: "https://example.com"
});

// 记录工作流事件
await logWorkflowEvent({
  sessionId: session.sessionId,
  event: "phase_completed",
  data: {
    phase: "reconnaissance",
    duration: 300,
    findings: 15
  }
});

// 跟踪指标
await trackMetrics({
  sessionId: session.sessionId,
  metrics: {
    cost: 0.5,
    turns: 10,
    time: 300
  }
});
```

---

## 附录

### A. 接口清单

| 接口类型 | 接口名称 | 描述 |
|----------|----------|------|
| CLI | start | 启动渗透测试 |
| CLI | logs | 查看日志 |
| CLI | query | 查询状态 |
| CLI | stop | 停止容器 |
| 工作流 | runPentestWorkflow | 运行完整工作流 |
| 工作流 | runReconnaissance | 执行侦察阶段 |
| 工作流 | runVulnerabilityAnalysis | 执行漏洞分析 |
| 工作流 | runExploitation | 执行漏洞利用 |
| 工作流 | generateReport | 生成报告 |
| 智能体 | executeAgent | 执行智能体 |
| 智能体 | handleMessage | 处理消息 |
| 智能体 | formatOutput | 格式化输出 |
| 审计 | createAuditSession | 创建会话 |
| 审计 | logWorkflowEvent | 记录事件 |
| 审计 | trackMetrics | 跟踪指标 |
| 审计 | generateAuditReport | 生成报告 |

### B. 参考资料

1. [Temporal.io API 文档](https://docs.temporal.io/api)
2. [Anthropic API 文档](https://docs.anthropic.com/)
3. [RESTful API 设计指南](https://restfulapi.net/)

---

## 文档修订历史

| 版本 | 日期 | 修订内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2026-02-12 | 初始版本 | purpose168 |
